import{u as J,B as G,I as T}from"./index-dpw65rou.js";import{u as te,b as ve,M as fe,l as pe,D as he}from"./ManagerLayout-BvWGsa5U.js";import{c as me}from"./useAutoReveal-D346XYK5.js";import{ad as ge,j as le,r as $,c as I,e as F,k as D,t as A,l as M,n as xe,d as be,B as j,C as R,u as f,J as g,A as Ce,H as O,I as X,a4 as z,F as B}from"./vue-vendor-Tej308t_.js";import{V as ye,W as Re,X as _e,Y as we,Z as Ae,P as q}from"./element-plus-7YpE0pad.js";import"./icons-B-GXtYFD.js";const Z=ge("panel",{state:()=>({contexts:{},isPaused:!1,isAutoRevealing:!1}),actions:{getContext(e){return e&&this.contexts[e]||null},setContext(e,a){this.contexts[e]=a},setAmount(e,a){this.contexts[e]&&(this.contexts[e].amount=a)},hasSelection(e){const a=this.getContext(e);return a?!!(a.amount.x&&a.amount.y):!1},hasContext(e){return!!this.contexts[e]},removeContext(e){return this.contexts[e]?(delete this.contexts[e],!0):!1},setPaused(e){this.isPaused=e},setRevealing(e){this.isAutoRevealing=e},importData(e){this.contexts=e.contexts},canReveal(e){if(!e)return!1;const a=e.amount.x*e.amount.y;return e.revealed.length<a},setOrder(e,a){this.contexts[e]&&(this.contexts[e].order=a)},addRevealedPanel(e,a){this.contexts[e]&&this.contexts[e].revealed.push(a)},clearRevealedPanels(e){this.contexts[e]&&(this.contexts[e].revealed=[])}}});function Pe(e,a){const{x:t,y:s}=a;if(e.startsWith("spiral")){const l=e.split("-"),o=l[1],n=l[2];return Me(s,t,{startPoint:o,direction:n})}const r=Array.from({length:s}).flatMap((l,o)=>Array.from({length:t},(n,p)=>[p,o]));if(e.startsWith("linear"))switch(e.replace("linear-","")){case"Right-Down":return r.sort((o,n)=>o[1]-n[1]||o[0]-n[0]);case"Right-Up":return r.sort((o,n)=>n[1]-o[1]||o[0]-n[0]);case"Left-Down":return r.sort((o,n)=>o[1]-n[1]||n[0]-o[0]);case"Left-Up":return r.sort((o,n)=>n[1]-o[1]||n[0]-o[0]);case"Down-Right":return r.sort((o,n)=>o[0]-n[0]||o[1]-n[1]);case"Down-Left":return r.sort((o,n)=>n[0]-o[0]||o[1]-n[1]);case"Up-Right":return r.sort((o,n)=>o[0]-n[0]||n[1]-o[1]);case"Up-Left":return r.sort((o,n)=>n[0]-o[0]||n[1]-o[1])}return ke(r)}function ke(e){const a=[...e];for(let t=a.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[a[t],a[s]]=[a[s],a[t]]}return a}function Me(e,a,t={}){const{startPoint:s="topLeft",direction:r="clockwise"}=t;if(e===0||a===0)return[];const l=[],o=e*a;if(s==="center"){let c=Math.floor((a-1)/2),x=Math.floor((e-1)/2);l.push([c,x]);const h=r==="clockwise"?[[1,0],[0,1],[-1,0],[0,-1]]:[[1,0],[0,-1],[-1,0],[0,1]];let P=1,k=0;for(;l.length<o;){for(let L=0;L<2;L++){for(let E=0;E<P&&!(l.length>=o);E++)c+=h[k][0],x+=h[k][1],c>=0&&c<a&&x>=0&&x<e&&l.push([c,x]);if(l.length>=o)break;k=(k+1)%4}P++}return l}let n=0,p=e-1,_=0,S=a-1;const b=()=>{for(let c=_;c<=S;c++)l.push([c,n]);n++},w=()=>{for(let c=n;c<=p;c++)l.push([S,c]);S--},C=()=>{for(let c=S;c>=_;c--)l.push([c,p]);p--},y=()=>{for(let c=p;c>=n;c--)l.push([_,c]);_++};let m=[];if(r==="clockwise")switch(s){case"topLeft":m=[b,w,C,y];break;case"topRight":m=[w,C,y,b];break;case"bottomRight":m=[C,y,b,w];break;case"bottomLeft":m=[y,b,w,C];break}else switch(s){case"topLeft":m=[w,b,y,C];break;case"topRight":m=[y,C,w,b];break;case"bottomRight":m=[C,w,b,y];break;case"bottomLeft":m=[b,y,C,w];break}let d=0;for(;l.length<o;)m[d%4](),d++;return l}function Se(){const{t:e}=J();return[{value:"random",label:e("mode.random"),icon:"PhShuffleSimple"},{value:"linear",label:e("mode.linear"),icon:"PhArrowsLeftRight"},{value:"spiral",label:e("mode.spiral"),icon:"PhArrowsClockwise"}]}function $e(){const{t:e}=J(),a=["topLeft","topRight","bottomRight","bottomLeft","center"],t=["clockwise","counterClockwise"],s=[];for(const r of a)for(const l of t)s.push({value:`${r}-${l}`,label:`${e(`mode.position.${r}`)}`,icon:l==="clockwise"?"PhArrowClockwise":"PhArrowCounterClockwise"});return s}function Ve(){const{t:e}=J(),a=["Right","Left"],t=["Down","Up"],s=[];for(const r of t)for(const l of a)s.push({value:`${l}-${r}`,label:`${e(`mode.direction.${l.toLowerCase()}`)} - ${e(`mode.direction.${r.toLowerCase()}`)}`,icon:`PhArrowElbow${l}${r}`}),s.push({value:`${r}-${l}`,label:`${e(`mode.direction.${r.toLowerCase()}`)} - ${e(`mode.direction.${l.toLowerCase()}`)}`,icon:`PhArrowElbow${r}${l}`});return s}function Y(e,a){if(a<=0)return[];const t=Math.floor(e/a),s=e%a,r=[];let l=0;for(let o=0;o<a;o++)(o+1)*s>l*a?(r.push(t+1),l++):r.push(t);return r}function ee(e,a){let t=0;for(let s=0;s<a.length;s++)if(t+=a[s],e<t)return s;return-1}function ae(e,a,t){return e.revealed.some(([s,r])=>s===a&&r===t)}function Le(e,a,t){const s=e.id,l=Z().getContext(s);ae(e,a,t)?l.revealed=e.revealed.filter(([o,n])=>!(o===a&&n===t)):l.revealed.push([a,t])}function U(e,a){if(!e.value||!a.value)return;const t=e.value.getContext("2d");if(!t)return;const s=a.value,{displayWidth:r,displayHeight:l}=s,{x:o,y:n}=s.amount;t.clearRect(0,0,r,l);const p=Y(r,o),_=Y(l,n),b=r*l/(o*n)>500;t.strokeStyle="rgb(255,255,255)",t.lineWidth=1,t.fillStyle="rgb(66,66,66)";const w=r/o,C=l/n,y=Math.min(w,C)*.4;let m=0;for(let d=0;d<n;d++){const c=_[d];let x=0;for(let h=0;h<o;h++){const P=p[h];if(!ae(s,h,d)){t.fillRect(x,m,P,c),b&&t.strokeRect(x,m,P,c);const k=d*o+h+1;t.fillStyle="rgba(255, 255, 255, 0.3)",t.font=`${y}px "Noto Sans TC", "Microsoft JhengHei", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(k.toString(),x+P/2,m+c/2),t.fillStyle="rgb(66,66,66)"}x+=P}m+=c}}function Ie(e,a,t){if(!a.value||!t.value)return;const s=t.value,{displayWidth:r,displayHeight:l}=s,{x:o,y:n}=s.amount,p=a.value.getBoundingClientRect(),_=(e.clientX-p.left)/p.width*r,S=(e.clientY-p.top)/p.height*l,b=Y(r,o),w=Y(l,n),C=ee(_,b),y=ee(S,w);C===-1||y===-1||Le(s,C,y)}const{startReveal:De,stopReveal:Ue,pauseReveal:We,resumeReveal:ze,revealAll:Be,coverAll:Fe}=me({useStore:Z,generateOrder:Pe,setRevealingMethod:"setRevealing",addRevealedMethod:"addRevealedPanel",customRevealAll:(e,a)=>{const t=a.getContext(e);if(!t)return!1;const{x:s,y:r}=t.amount,l=[];for(let o=0;o<r;o++)for(let n=0;n<s;n++)t.revealed.some(([p,_])=>p===n&&_===o)||l.push([n,o]);return l.length===0||l.forEach(o=>{a.addRevealedPanel(e,o)}),!0},customCoverAll:(e,a)=>a.getContext(e)?(a.clearRevealedPanels(e),!0):!1}),Ee={class:"display-root"},He={class:"display-canvas-container",ref:"canvasContainer"},Ne=["width","height"],Ge=["width","height"],Te=le({__name:"Panel",props:{id:{default:null},isManualMode:{type:Boolean,default:!0}},setup(e,{expose:a}){const t=e,s=te(),r=Z(),l=$(null),o=$(null),n=I(()=>{if(!t.id)return{};const d=s.getData(t.id),c=r.getContext(t.id);return{...d,...c}}),p=d=>{!o.value||!n.value||r.isAutoRevealing||!t.isManualMode||(Ie(d,o,n),U(o,n))};a({startAutoReveal:()=>{if(!t.id)return!1;const d=r.getContext(t.id);return!d||!r.canReveal(d)?!1:(De({id:t.id,duration:d.duration||5e3,onReveal:()=>{U(o,n)}}),!0)},pauseAutoReveal:()=>(We(),!0),resumeAutoReveal:()=>(ze(),!0),stopAutoReveal:()=>(Ue(),!0),revealAllPanels:()=>t.id?Be(t.id,()=>{U(o,n)}):!1,coverAllPanels:()=>t.id?Fe(t.id,()=>{U(o,n)}):!1}),F(()=>t.id,d=>{d&&xe(()=>{m(),U(o,n)})},{immediate:!0}),F(()=>{var d;return(d=n.value)==null?void 0:d.revealed},d=>{d&&U(o,n)},{deep:!0});const m=()=>{if(!l.value||!n.value)return;const d=n.value,c=l.value.getContext("2d");c&&(c.clearRect(0,0,d.displayWidth,d.displayHeight),c.drawImage(d.renderable,0,0,d.displayWidth,d.displayHeight))};return(d,c)=>(M(),D("div",Ee,[A("div",He,[A("canvas",{ref_key:"mainCanvas",ref:l,width:n.value.displayWidth,height:n.value.displayHeight,style:{"pointer-events":"none"}},null,8,Ne),A("canvas",{ref_key:"panelCanvas",ref:o,class:"panelCanvas",width:n.value.displayWidth,height:n.value.displayHeight,style:{position:"absolute",cursor:"pointer"},onClick:p},null,8,Ge)],512)]))}}),je={class:"top-bar-section common-utils"},Oe={class:"grid-selector"},Xe={class:"top-bar-section auto-play"},Ye={class:"duration-control"},Je={style:{display:"flex","align-items":"center"}},Ze={style:{display:"flex","align-items":"center"}},qe={style:{display:"flex","align-items":"center"}},Ke={class:"top-bar-section mode-toggle"},Qe={key:0,class:"floating-play-button"},st=le({__name:"PanelManager",setup(e){const a=te(),t=Z(),{t:s}=J(),{fileInput:r,currentId:l,canGoPrev:o,canGoNext:n,isAutoRevealing:p,isPaused:_,triggerFileInput:S,onFileChange:b,handleDataSelect:w,goToPrev:C,goToNext:y}=ve({dataStore:a,extraStore:t,dataType:"image",fileAccept:"image/*",loadFile:pe,onFileAdded:(i,v)=>{v==="added"&&t.setContext(i,{revealed:[],isManual:h.value,autoRevealMode:L.value,duration:x.value,amount:{x:d.value,y:c.value}})}}),m=$(null),d=$(5),c=$(5),x=$(1e3),h=$(!0),P=$("random"),k=$(""),L=I(()=>P.value+(k.value?`-${k.value}`:"")),E=I(()=>{const i=t.getContext(l.value);return i?i.amount.x*i.amount.y>i.revealed.length&&i.revealed.length>0:!1}),K=I(()=>{const i=t.getContext(l.value);return i&&i.revealed.length<i.amount.x*i.amount.y}),oe=I(()=>{var i;return((i=t.getContext(l.value))==null?void 0:i.revealed.length)>0}),H=I({get:()=>x.value/1e3,set:i=>{x.value=Math.round(i*1e3);const v=t.getContext(l.value);v&&t.setContext(l.value,{...v,duration:x.value})}}),Q=I(()=>({icon:h.value?"PhCursorClick":"PhClockClockwise",tooltip:h.value?s("panel.switchToAuto"):s("panel.switchToManual")})),ne=i=>i.startsWith("spiral")?["spiral",i.replace("spiral-","")]:i.startsWith("linear")?["linear",i.replace("linear-","")]:[i,""],se=()=>{var i,v,N;if(p.value)_.value?(v=m.value)==null||v.resumeAutoReveal():(N=m.value)==null||N.pauseAutoReveal();else{if(l.value){const V=t.getContext(l.value);V&&t.setContext(l.value,{...V,autoRevealMode:L.value})}(i=m.value)==null||i.startAutoReveal()}},re=()=>{var i;(i=m.value)==null||i.revealAllPanels()},ie=()=>{var i;(i=m.value)==null||i.coverAllPanels()},ue=()=>{h.value=!h.value;const i=t.getContext(l.value);i&&t.setContext(l.value,{...i,isManual:h.value})};return F([d,c],([i,v])=>{l.value&&t.setAmount(l.value,{x:i,y:v})}),F(l,i=>{const v=t.getContext(i);v&&(x.value=v.duration||1e3,h.value=v.isManual,d.value=v.amount.x,c.value=v.amount.y,[P.value,k.value]=ne(v.autoRevealMode))}),F(L,()=>{const i=t.getContext(l.value);i&&t.setContext(l.value,{...i,autoRevealMode:L.value})}),be(()=>{const i=a.getAllData();i.length>0&&i.forEach(v=>{t.hasContext(v.id)||t.setContext(v.id,{revealed:[],isManual:!0,autoRevealMode:"random",amount:{x:d.value,y:c.value},duration:x.value})})}),(i,v)=>{const N=we,V=Ae,W=_e,ce=ye,de=Re;return M(),j(fe,{"can-go-prev":f(o),"can-go-next":f(n),disabled:f(p),onGoPrev:f(C),onGoNext:f(y)},{"file-input":R(()=>[A("input",{ref_key:"fileInput",ref:r,type:"file",accept:"image/*",onChange:v[0]||(v[0]=(...u)=>f(b)&&f(b)(...u)),style:{display:"none"}},null,544)]),"common-utils":R(()=>[A("div",je,[g(N,null,{default:R(()=>[g(G,{onClick:ie,icon:"PhEyeClosed",title:f(s)("topbar.hideAll"),disabled:!oe.value},null,8,["title","disabled"]),g(G,{onClick:re,icon:"PhFrameCorners",title:f(s)("topbar.showAll"),disabled:!K.value},null,8,["title","disabled"])]),_:1}),A("div",Oe,[g(W,{modelValue:d.value,"onUpdate:modelValue":v[1]||(v[1]=u=>d.value=u),size:"small",style:{width:"60px"},disabled:f(p)},{default:R(()=>[(M(),D(B,null,z(100,u=>g(V,{key:`x-${u}`,value:u,label:u},null,8,["value","label"])),64))]),_:1},8,["modelValue","disabled"]),g(T,{name:"PhX"}),g(W,{modelValue:c.value,"onUpdate:modelValue":v[2]||(v[2]=u=>c.value=u),size:"small",style:{width:"60px"},disabled:f(p)},{default:R(()=>[(M(),D(B,null,z(100,u=>g(V,{key:`y-${u}`,value:u,label:u},null,8,["value","label"])),64))]),_:1},8,["modelValue","disabled"])])])]),"auto-play-controls":R(()=>[A("div",Xe,[O(A("div",Ye,[g(ce,{modelValue:H.value,"onUpdate:modelValue":v[3]||(v[3]=u=>H.value=u),min:.1,max:10,step:.1,style:{width:"120px"},disabled:h.value||f(p),"show-tooltip":!1},null,8,["modelValue","disabled"]),g(de,{modelValue:H.value,"onUpdate:modelValue":v[4]||(v[4]=u=>H.value=u),min:.1,max:10,step:.1,size:"small",disabled:h.value||f(p)},null,8,["modelValue","disabled"])],512),[[X,!h.value]]),O(g(W,{class:"text-select",modelValue:P.value,"onUpdate:modelValue":v[5]||(v[5]=u=>P.value=u),size:"small",disabled:f(p)||h.value},{default:R(()=>[(M(!0),D(B,null,z(f(Se)(),u=>(M(),j(V,{key:u.value,label:u.label,value:u.value},{default:R(()=>[A("div",Je,[g(T,{name:u.icon,style:{"margin-right":"5px"}},null,8,["name"]),A("span",null,q(u.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),[[X,!h.value]]),O(g(W,{class:"text-select",modelValue:k.value,"onUpdate:modelValue":v[6]||(v[6]=u=>k.value=u),size:"small",disabled:f(p)||h.value,placeholder:f(s)("panel.directionPriority")},{default:R(()=>[(M(!0),D(B,null,z(f(Ve)(),u=>(M(),j(V,{key:u.value,label:u.label,value:u.value},{default:R(()=>[A("div",Ze,[g(T,{name:u.icon,style:{"margin-right":"5px"}},null,8,["name"]),A("span",null,q(u.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled","placeholder"]),[[X,!h.value&&P.value==="linear"]]),O(g(W,{class:"text-select",modelValue:k.value,"onUpdate:modelValue":v[7]||(v[7]=u=>k.value=u),size:"small",disabled:f(p)||h.value,placeholder:f(s)("panel.directionAndStart")},{default:R(()=>[(M(!0),D(B,null,z(f($e)(),u=>(M(),j(V,{key:u.value,label:u.label,value:u.value},{default:R(()=>[A("div",qe,[g(T,{name:u.icon,style:{"margin-right":"5px"}},null,8,["name"]),A("span",null,q(u.label),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled","placeholder"]),[[X,!h.value&&P.value==="spiral"]])])]),"mode-toggle":R(()=>[A("div",Ke,[g(G,{icon:Q.value.icon,title:Q.value.tooltip,tooltipPlacement:"left",onClick:ue,disabled:f(p)||E.value},null,8,["icon","title","disabled"])])]),display:R(()=>[g(Te,{ref_key:"panel",ref:m,id:f(l),isManualMode:h.value},null,8,["id","isManualMode"])]),"floating-button":R(()=>[h.value?Ce("",!0):(M(),D("div",Qe,[g(G,{onClick:se,icon:f(p)&&!f(_)?"PhPause":"PhPlay",title:f(p)&&!f(_)?f(s)("topbar.pause"):f(s)("topbar.play"),"icon-size":28,disabled:!K.value,size:"large",circle:""},null,8,["icon","title","disabled"])]))]),sidebar:R(()=>[g(he,{"current-id":f(l),"data-store":f(a),"extra-store":f(t),"data-type":"image",onSelectData:f(w),onAddFile:f(S)},null,8,["current-id","data-store","extra-store","onSelectData","onAddFile"])]),_:1},8,["can-go-prev","can-go-next","disabled","onGoPrev","onGoNext"])}}});export{st as default};
