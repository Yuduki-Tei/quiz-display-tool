import{u as ee,B as N}from"./index-dpw65rou.js";import{u as J,a as te,b as oe,M as ae,l as se,D as le}from"./ManagerLayout-BvWGsa5U.js";import{ad as ne,j as K,ae as ie,r as T,c as R,e as G,k as ue,l as Q,t as S,H as X,I as Y,u as l,n as ce,d as re,B as de,C as Z,J as P}from"./vue-vendor-Tej308t_.js";import{V as me,W as he}from"./element-plus-7YpE0pad.js";import"./icons-B-GXtYFD.js";const E=ne("zoomer",{state:()=>({contexts:{},isPaused:!1,isZooming:!1}),actions:{getContext(s){return s&&this.contexts[s]||null},setContext(s,n){this.contexts[s]=n},setRect(s,n){this.contexts[s]&&(this.contexts[s].selection=n)},removeContext(s){return this.contexts[s]?(delete this.contexts[s],!0):!1},setPaused(s){this.isPaused=s},setZooming(s){this.isZooming=s},hasSelection(s){const n=this.getContext(s);return n?!!(n.selection.w&&n.selection.h):!1},hasContext(s){return!!this.contexts[s]},importData(s){this.contexts=s.contexts}}});let L=null;function ve(s){const n=E();n.setZooming(!0),n.setPaused(!1);let o=!1,i=!1,f=null,u=performance.now(),r=0;const{canvas:g,renderable:t,naturalWidth:_,naturalHeight:C,displayWidth:p,displayHeight:x,selection:h,duration:A}=s,v=g.getContext("2d");if(!v)return;const y=h.w>=0?h.x:h.x+h.w,w=h.h>=0?h.y:h.y+h.h,F=Math.abs(h.w),M=Math.abs(h.h),b={x:y+F/2,y:w+M/2},d={w:F,h:M},k={x:p/2,y:x/2},H={w:p,h:x},W=_/p,a=C/x;function e(I){if(o||i)return;let c=Math.min((I-u)/A,1);c=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2;const V=b.x+(k.x-b.x)*c,z=b.y+(k.y-b.y)*c,U=d.w+(H.w-d.w)*c,q=d.h+(H.h-d.h)*c;let D=(V-U/2)*W,O=(z-q/2)*a,$=U*W,B=q*a;D<0&&($+=D,D=0),O<0&&(B+=O,O=0),D+$>_&&($=_-D),O+B>C&&(B=C-O),v.clearRect(0,0,p,x),v.drawImage(t,D,O,$,B,0,0,p,x),c<1?f=requestAnimationFrame(e):(i=!0,v.clearRect(0,0,p,x),v.drawImage(t,0,0,_,C,0,0,p,x),n.setZooming(!1))}f=requestAnimationFrame(e);const m={pause(){!o&&!i&&(o=!0,r=performance.now(),n.setPaused(!0))},resume(){o&&!i&&(o=!1,u+=performance.now()-r,f=requestAnimationFrame(e),n.setPaused(!1))},stop(){i=!0,f&&cancelAnimationFrame(f),n.setZooming(!1),n.setPaused(!1)}};return L=m,m}function pe(){L&&(L.stop(),L=null)}function j(s){pe();const{renderable:n,canvas:o,naturalWidth:i,naturalHeight:f,displayWidth:u,displayHeight:r}=s,g=o.getContext("2d");g&&(g.clearRect(0,0,u,r),g.drawImage(n,0,0,i,f,0,0,u,r))}const fe={class:"display-root"},ge={class:"display-canvas-container",ref:"canvasContainer"},xe=["width","height"],ye=["width","height"],we=K({__name:"Zoomer",props:{id:{default:null},displayMode:{default:"full"}},setup(s,{expose:n}){const o=s,i=E(),f=J(),{isZooming:u}=ie(i),r=T(null),g=T(null),t=R(()=>{if(!o.id)return{};const e=f.getData(o.id),m=i.getContext(o.id);return{...e,...m}}),_=R(()=>{var e,m;return((e=t.value)==null?void 0:e.displayWidth)/((m=t.value)==null?void 0:m.displayHeight)||1}),C=e=>{o.id&&i.setRect(o.id,e)},{isDragging:p,onMouseDown:x,onMouseMove:h,onMouseUp:A,drawSelection:v}=te(_,t,C),y=()=>{t.value.selection&&t.value.selection.w!==0&&t.value.selection.h!==0&&v(r.value)},w=()=>{var m;if(!r.value||!((m=t.value)!=null&&m.renderable))return;const e=r.value.getContext("2d");if(e)if(e.clearRect(0,0,t.value.displayWidth,t.value.displayHeight),o.displayMode==="selection"&&t.value.selection&&t.value.selection.w&&t.value.selection.h){const I=t.value.selection,c=t.value.renderable.width/t.value.displayWidth,V=t.value.renderable.height/t.value.displayHeight,z={x:I.x*c,y:I.y*V,w:I.w*c,h:I.h*V};e.drawImage(t.value.renderable,z.x,z.y,z.w,z.h,0,0,t.value.displayWidth,t.value.displayHeight)}else(o.displayMode==="full"||u.value)&&(j({...t.value,canvas:r.value}),y())},F=e=>{u.value||!r.value||o.displayMode!=="full"||x(e,r.value)},M=e=>{u.value||!r.value||o.displayMode!=="full"||(h(e,r.value),p.value&&w())},b=()=>{A(),w()};let d=null;return n({startZoomOut:()=>{var e;!g.value||!((e=t.value)!=null&&e.renderable)||(d=ve({...t.value,canvas:g.value}))},pauseZoomOut:()=>{d==null||d.pause()},resumeZoomOut:()=>{d==null||d.resume()},showFullImage:()=>{var e;!r.value||!((e=t.value)!=null&&e.renderable)||(j({...t.value,canvas:r.value}),y(),u.value&&(d=null))}}),G(()=>o.id,e=>{e&&ce(()=>{w()})},{immediate:!0}),G(()=>o.displayMode,()=>{w()}),(e,m)=>(Q(),ue("div",fe,[S("div",ge,[X(S("canvas",{ref_key:"mainCanvas",ref:r,width:t.value.displayWidth,height:t.value.displayHeight,onMousedown:F,onMousemove:M,onMouseup:b},null,40,xe),[[Y,!l(u)&&o.displayMode!=="none"]]),X(S("canvas",{ref_key:"zoomCanvas",ref:g,width:t.value.displayWidth,height:t.value.displayHeight,class:"zoom-canvas"},null,8,ye),[[Y,l(u)]])],512)]))}}),be={class:"top-bar-section common-utils"},_e={class:"top-bar-section auto-play"},Me={class:"duration-control"},Se={class:"top-bar-section mode-toggle"},Ce={class:"floating-play-button"},De=K({__name:"ZoomerManager",setup(s){const n=J(),o=E(),{t:i}=ee(),{fileInput:f,currentId:u,canGoPrev:r,canGoNext:g,isZooming:t,isPaused:_,triggerFileInput:C,onFileChange:p,handleDataSelect:x,goToPrev:h,goToNext:A}=oe({dataStore:n,extraStore:o,dataType:"image",fileAccept:"image/*",loadFile:se,onFileAdded:(a,e)=>{e==="added"&&o.setContext(a,{duration:y.value,selection:{x:0,y:0,w:0,h:0}})}}),v=T(null),y=T(3e4),w=T("full"),F=R(()=>o.hasSelection(u.value)),M=R({get:()=>Math.round(y.value/1e3),set:a=>{y.value=a*1e3,u.value&&o.setContext(u.value,{duration:y.value,selection:o.getContext(u.value).selection})}}),b=[{value:"full",icon:"PhImage",currentLabel:i("zoomer.showFullImage"),nextLabel:i("zoomer.switchToShowSelectedArea")},{value:"selection",icon:"PhCrop",currentLabel:i("zoomer.showSelectedArea"),nextLabel:i("zoomer.switchToHideImage")},{value:"none",icon:"PhEyeSlash",currentLabel:i("zoomer.hideImage"),nextLabel:i("zoomer.switchToShowFullImage")}],d=R(()=>{const a=b.find(e=>e.value===w.value);return{icon:(a==null?void 0:a.icon)||"PhImage",tooltip:(a==null?void 0:a.nextLabel)||i("zoomer.switchToShowSelectedArea")}}),k=()=>{var a,e,m;t.value?_.value?(e=v.value)==null||e.resumeZoomOut():(m=v.value)==null||m.pauseZoomOut():(a=v.value)==null||a.startZoomOut()},H=()=>{var a;return(a=v.value)==null?void 0:a.showFullImage()},W=()=>{const a=b.findIndex(e=>e.value===w.value);w.value=b[(a+1)%b.length].value};return G(u,a=>{if(a){const e=o.getContext(a);e&&typeof e.duration=="number"&&(y.value=e.duration)}}),re(()=>{const a=n.getAllData();a.length>0&&a.forEach(e=>{o.hasContext(e.id)||o.setContext(e.id,{duration:y.value,selection:{x:0,y:0,w:0,h:0}})})}),(a,e)=>{const m=me,I=he;return Q(),de(ae,{"can-go-prev":l(r),"can-go-next":l(g),disabled:l(t),onGoPrev:l(h),onGoNext:l(A)},{"file-input":Z(()=>[S("input",{ref_key:"fileInput",ref:f,type:"file",accept:"image/*",onChange:e[0]||(e[0]=(...c)=>l(p)&&l(p)(...c)),style:{display:"none"}},null,544)]),"common-utils":Z(()=>[S("div",be,[P(N,{onClick:H,disabled:!l(u)||!l(t),icon:"PhCornersOut",title:l(i)("topbar.showAll")},null,8,["disabled","title"])])]),"auto-play-controls":Z(()=>[S("div",_e,[S("div",Me,[P(m,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=c=>M.value=c),min:1,max:50,step:1,style:{width:"120px"},disabled:l(t),"show-tooltip":!1},null,8,["modelValue","disabled"]),P(I,{modelValue:M.value,"onUpdate:modelValue":e[2]||(e[2]=c=>M.value=c),min:1,max:50,step:1,size:"small",disabled:l(t)},null,8,["modelValue","disabled"])])])]),"mode-toggle":Z(()=>[S("div",Se,[P(N,{icon:d.value.icon,title:d.value.tooltip,tooltipPlacement:"left",onClick:W,disabled:l(t)},null,8,["icon","title","disabled"])])]),display:Z(()=>[P(we,{ref_key:"zoomer",ref:v,id:l(u),displayMode:w.value},null,8,["id","displayMode"])]),"floating-button":Z(()=>[S("div",Ce,[P(N,{onClick:k,icon:l(t)&&!l(_)?"PhPause":"PhPlay",title:l(t)&&!l(_)?l(i)("topbar.pause"):l(i)("topbar.play"),"icon-size":28,disabled:!F.value,size:"large",circle:""},null,8,["icon","title","disabled"])])]),sidebar:Z(()=>[P(le,{"current-id":l(u),"data-store":l(n),"extra-store":l(o),"data-type":"image",onSelectData:l(x),onAddFile:l(C)},null,8,["current-id","data-store","extra-store","onSelectData","onAddFile"])]),_:1},8,["can-go-prev","can-go-next","disabled","onGoPrev","onGoNext"])}}});export{De as default};
